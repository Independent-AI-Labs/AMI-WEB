#!/usr/bin/env bash
# Native git pre-push hook - runs tests before pushing
# Ensures all tests pass before code reaches remote

set -euo pipefail

# Standardized terminology: MODULE_ROOT and ORCHESTRATOR_ROOT only
MODULE_ROOT="$(git rev-parse --show-toplevel)"

# Check if this is orchestrator root or a submodule
if [ -f "$MODULE_ROOT/.git" ]; then
    # Submodule
    MODULE_NAME="$(basename "$MODULE_ROOT")"
    IS_ROOT=false
else
    # Orchestrator root
    MODULE_NAME="root"
    IS_ROOT=true
fi

echo "Running pre-push tests for ${MODULE_NAME}..."
echo "=========================================="

# Run tests
if [ -f "$MODULE_ROOT/scripts/run_tests.py" ]; then
    # Module has custom test runner
    if ! "$MODULE_ROOT/.venv/bin/python" "$MODULE_ROOT/scripts/run_tests.py"; then
        echo "✗ Tests failed"
        exit 1
    fi
else
    # Fall back to pytest
    if ! "$MODULE_ROOT/.venv/bin/python" -m pytest -q; then
        echo "✗ Tests failed"
        exit 1
    fi
fi

echo "=========================================="
echo "✓ All tests passed!"
exit 0
